#
# .shrc:
#	Common part of .bashrc, .zshrc, etc.
#

start_gpgagent()
{
	local _info _pinentry

	which gpg-agent >/dev/null 2>&1 || return

	_info="${HOME}/.gpg-agent-info"

	export GPG_TTY=$(tty)

	if ! pgrep -x -u "${USER}" gpg-agent >/dev/null 2>&1; then
		_pinentry=$(which pinentry-curses 2>/dev/null)
		if [ $? = 0 ]; then
			gpg-agent --daemon --write-env-file ${_info} \
			    --pinentry-program "${_pinentry}" >/dev/null
		else
			gpg-agent --daemon --write-env-file ${_info} >/dev/null
		fi
	fi

	unset GPG_AGENT_INFO
	gpg-connect-agent /bye >/dev/null 2>&1

	if [ $? = 0 ]; then
		# gnupg 2.1 or later
		unset SSH_AGENT_PID
		if [ "${gnupg_SSH_AUTH_SOCK_by:-0}" -ne $$ ]; then
			export SSH_AUTH_SOCK="${HOME}/.gnupg/S.gpg-agent.ssh"
		fi
	else
		# gnupg 2.0
		if [ -f "${_info}" ]; then
			. "${_info}"
			export GPG_AGENT_INFO
			export SSH_AUTH_SOCK
		fi
	fi

	gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1
}

stty -ixon
stty status '^T' 2>/dev/null

start_gpgagent
