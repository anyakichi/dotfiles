#!/bin/bash

set -o pipefail

do_find()
{
    local opts

    opts=()

    if [[ "$1" == "d" ]]; then
        opts+=(-type d -printf "%p/\n")
    elif [[ "$1" == "f" ]]; then
        opts+=(-type f -print -o -type l -print)
    else
        opts+=(-type d -printf "%p/\n" -o -type f -print -o -type l -print)
    fi

    if (( $2 > 0 )); then
        opts+=(-maxdepth "$2")
    fi

    find -L . -mindepth 1 -xdev -path '*/\.*' -prune -o "${opts[@]}" 2>/dev/null \
        | cut -b3-
}

do_fd()
{
    local opts

    opts=()

    if [[ "$1" == "d" ]]; then
        opts+=(--type d)
    elif [[ "$1" == "f" ]]; then
        opts+=(--type f --type l)
    fi

    if (( $2 > 0 )); then
        opts+=(-d "$2")
    fi

    fd -L --one-file-system --color=always "${opts[@]}" 2>/dev/null
}

if command -v fd >/dev/null 2>&1; then
    do_fd "$@"
else
    do_find "$@"
fi
