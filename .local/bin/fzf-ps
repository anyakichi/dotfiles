#!/bin/bash

set -o pipefail

CMD="$1"
shift

case "$CMD" in
    list)
        read -ra args <"$FZF_PS_STATE"
        ps ux "${args[@]}"
        ;;
    run)
        FZF_PS_STATE=$(mktemp)
        export FZF_PS_STATE

        fzf_args=()
        while (( ${#@} > 0 )); do
            if [[ "$1" == "--" ]]; then
                shift
                printf "%q " "$@" > "$FZF_PS_STATE"
                break
            fi
            fzf_args+=("$1")
            shift
        done

        "$0" list \
            | fzf -m --header-lines=1 \
                --bind "ctrl-r:reload('$0' list)" \
                --bind "ctrl-d:reload('$0' toggle-all && '$0' list)" \
                "${fzf_args[@]}" \
            | awk '{print $2}'

        rm -f "$FZF_PS_STATE"
        ;;
    toggle-all)
        read -ra args <"$FZF_PS_STATE"

        if [[ " ${args[0]} " == *" a "* ]]; then
            # inexact conversion
            read -ra args <<<"${args[@]/a/}"
        else
            args+=(a)
        fi

        echo "${args[@]}" > "$FZF_PS_STATE"
        ;;
    *)
        exit 1
        ;;
esac
