#!/bin/bash

XIDLEHOOK_SOCKET=${XDG_RUNTIME_DIR}/xidlehook.sock

service_start()
{
    local name="$1"
    shift
    ( exec -a "${name}" bash "$0" "$@" ) & disown
}

service_stop()
{
    pkill -f "^$1" &>/dev/null
}

service_restart()
{
    service_stop "$1" && sleep 0.5
    service_start "$@"
}

xidlehook_send()
{
    echo -ne "$1" | socat - "UNIX-CONNECT:${XIDLEHOOK_SOCKET}"
}

dim()
{
    local brightness display

    case "$1" in
        on)
            brightness=0.5
            ;;
        off)
            brightness=1.0
            ;;
        reset)
            brightness="$(xrandr --verbose | awk '/Brightness/ { print $2; exit }')" 2>/dev/null
            ;;
    esac

    if [[ -n "${brightness}" ]]; then
        if command -v redshift &>/dev/null; then
            redshift -o -P -b "${brightness}:${brightness}" &>/dev/null
        else
            display="$(xrandr | awk '/ primary/ {print $1}')" 2>/dev/null
            xrandr --output "${display}" --brightness "${brightness}"
        fi
    fi
}

main()
{
    local path main_argv0 sleep_argv0

    path="$(realpath "$0")"
    main_argv0="${path}: main service"
    sleep_argv0="${path}: sleep service"

    case "$1" in
        start)
            service_start "$main_argv0" __start
            ;;
        __start)
            trap "kill 0" SIGINT SIGTERM EXIT

            xset s off -dpms &>/dev/null
            dim off

            xidlehook \
                --socket "${XIDLEHOOK_SOCKET}" \
                --timer normal 10 "$0 try-blank" "" \
                --timer normal 170 "$0 dim" "$0 undim" \
                --timer primary 30 "$0 blank" "" \
                --timer normal 30 "$0 sleep" "$0 wakeup" &
            xss-lock -l -- \
                ~/.local/sbin/i3lock.sh -k -B 10 --indicator \
                    --insidecolor ffffff88 &

            wait
            ;;
        stop)
            service_stop "$main_argv0"
            ;;
        enable)
            xidlehook_send "\x1"
            ;;
        disable)
            xidlehook_send "\x0"
            ;;
        lock)
            xset s activate &>/dev/null
            ;;
        try-blank)
            pgrep -U "${USER}" i3lock &>/dev/null && main blank
            ;;
        blank)
            dim off
            xset dpms force off &>/dev/null
            ;;
        dim)
            dim on
            ;;
        undim)
            dim off
            ;;
        redshift)
            dim reset
            ;;
        sleep)
            service_start "$sleep_argv0" __sleep
            ;;
        __sleep)
            while true; do
                local loadavg1

                loadavg1="$(head -c 4 /proc/loadavg)"
                if pgrep -U "${USER}" i3lock &>/dev/null \
                    && ! pacmd list-sink-inputs | grep 'state: RUNNING' &>/dev/null \
                    && (( ${loadavg1%.*} < 1 ));
                then
                    systemctl suspend || light-locker-command --lock
                    break
                fi
                sleep 10
            done
            ;;
        wakeup)
            service_stop "$sleep_argv0"
            ;;
    esac
}

main "$@"
