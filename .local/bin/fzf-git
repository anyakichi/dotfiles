#!/bin/bash

set -o pipefail

# shellcheck source=./_fzf-state
. "${0%/*}/_fzf-state"

fzf-down() {
    fzf --height 50% "$@"
}

git_diff() {
    case "$1" in
    view)
        args=()

        if [[ "${S[cached]}" == true ]]; then
            args+=(--cached)
        fi

        echo git diff "${args[@]}" "${@:2}"
        git diff --color=always "${args[@]}" "${@:2}" |
            sed 1,4d | less -KMRc
        ;;
    toggle-cached)
        if [[ "${S[cached]}" == true ]]; then
            S[cached]="false"
        else
            S[cached]="true"
        fi
        ;;
    *)
        exit 1
        ;;
    esac
}

git_log() {
    case "$1" in
    view)
        args=()

        if [[ "${S[graph]}" == true ]]; then
            args+=(--graph)
        fi

        if [[ ${S[target]} ]]; then
            args+=("${S[target]}")
        fi

        git -c core.pager="less -+F -KMc" log --date=short --color=always \
            --format="%C(blue)%C(bold)%cd %C(cyan)%<(8,trunc)%aL %C(auto)%d %s %C(240)%h" \
            "${args[@]}" "${@:2}"
        ;;
    switch)
        TVIEW_ENV_VARS=FZF_STATE tview fzf-git log _switch
        ;;
    _switch)
        res=$(fzf-git branch --height 100%)
        if [[ $res ]]; then
            S[target]="res"
        fi
        ;;
    toggle-graph)
        if [[ "${S[graph]}" == true ]]; then
            S[graph]="false"
        else
            S[graph]="true"
        fi
        ;;
    *)
        exit 1
        ;;
    esac
}

gb() {
    local view
    view="fzf-git log view \$(sed s/^..// <<< {} | cut -d' ' -f1)"

    git branch -a --color=always | grep -v '/HEAD\s' |
        fzf-down --ansi --multi --preview-window right:70% \
            --bind "ctrl-r:execute-silent(fzf-git log toggle-graph)+refresh-preview" \
            --bind "ctrl-t:execute:tview $view" \
            --preview "$view | head -500" \
            "$@" |
        sed 's/^..//' | cut -d' ' -f1 |
        sed 's#^remotes/##'
}

gf() {
    local view
    view="fzf-git diff view -- {-1}"

    git -c color.status=always status --short --no-branch |
        fzf-down -m --ansi --nth 2..,.. \
            --bind "ctrl-r:execute-silent(fzf-git diff toggle-cached)+refresh-preview" \
            --bind "ctrl-t:execute:tview $view" \
            --preview "$view | head -500" \
            "$@" |
        cut -c4- | sed 's/.* -> //'
}

gh() {
    local view
    view="git -c core.pager='less -+F -KMc' show --color=always \$(grep -o '[a-f0-9]\{7,\}' <<< {})"

    fzf-git log view "$@" |
        fzf-down --ansi --no-sort --reverse --multi --bind 'ctrl-s:toggle-sort' \
            --bind "ctrl-r:execute(fzf-git log toggle-graph)+reload(fzf-git log view)" \
            --bind "ctrl-t:execute:tview $view" \
            --bind "ctrl-x:execute(fzf-git log switch)+reload(fzf-git log view)" \
            --preview "$view | head -500" |
        grep -o "[a-f0-9]\{7,\}"
}

gr() {
    local view
    view="fzf-git log view {1}"

    git remote -v | awk '{print $1 "\t" $2}' | uniq |
        fzf-down --tac \
            --bind "ctrl-r:execute-silent(fzf-git log toggle-graph)+refresh-preview" \
            --bind "ctrl-t:execute:tview $view" \
            --preview "$view | head -500" |
        cut -d$'\t' -f1
}

gs() {
    local view
    view="git -c core.pager='less -+F -KMc' stash show -p --stat --color=always \$(cut -d: -f1 <<< {})"

    git stash list |
        fzf-down --ansi --no-sort --reverse --multi --bind 'ctrl-s:toggle-sort' \
            --bind "ctrl-t:execute:tview $view" \
            --preview "$view | head -500" |
        cut -d ':' -f1
}

gt() {
    local view
    view="git -c core.pager='less -+F -KMc' show --color=always {}"

    git tag --sort -version:refname |
        fzf-down --multi --preview-window right:70% \
            --bind "ctrl-t:execute:tview $view" \
            --preview "$view | head -500"
}

case "$1" in
branch)
    gb "${@:2}"
    ;;
diff)
    git_diff "${@:2}"
    ;;
file)
    gf "${@:2}"
    ;;
hash)
    gh "${@:2}"
    ;;
log)
    git_log "${@:2}"
    ;;
remote)
    gr "${@:2}"
    ;;
stash)
    gs "${@:2}"
    ;;
tag)
    gt "${@:2}"
    ;;
esac
