#!/bin/bash

fzf-down() {
    fzf --height 50% "$@" --border
}

gb() {
    local state view
    state=$(mktemp)
    view="fzf-git-log $state run \$(sed s/^..// <<< {} | cut -d' ' -f1)"

    git branch -a --color=always | command grep -v '/HEAD\s' \
        | fzf-down --ansi --multi --preview-window right:70% \
            --bind "ctrl-r:execute-silent(fzf-git-log $state toggle-graph)+refresh-preview" \
            --bind "ctrl-t:execute:fzf-view $view" \
            --preview "$view | head -500" \
            "$@" \
        | sed 's/^..//' | cut -d' ' -f1 \
        | sed 's#^remotes/##'

    rm -f "$state"
}

gf() {
    local state view
    state=$(mktemp)
    view="fzf-git-diff $state run -- {-1}"

    git -c color.status=always status --short --no-branch \
        | fzf-down -m --ansi --nth 2..,.. \
            --bind "ctrl-r:execute-silent(fzf-git-diff $state toggle-cached)+refresh-preview" \
            --bind "ctrl-t:execute:fzf-view $view" \
            --preview "$view | head -500" \
            "$@" \
        | cut -c4- | sed 's/.* -> //'

    rm -f "$state"
}

gh() {
    local state view
    state=$(mktemp)
    view="git -c core.pager='less -+F -KMc' show --color=always \$(grep -o '[a-f0-9]\{7,\}' <<< {})"

    fzf-git-log "$state" run "$@" \
        | fzf-down --ansi --no-sort --reverse --multi --bind 'ctrl-s:toggle-sort' \
            --bind "ctrl-r:execute(fzf-git-log $state toggle-graph)+reload(fzf-git-log $state run)" \
            --bind "ctrl-t:execute:fzf-view $view" \
            --bind "ctrl-x:execute(fzf-git-log $state switch)+reload(fzf-git-log $state run)" \
            --preview "$view | head -500" \
        | command grep -o "[a-f0-9]\{7,\}"

    rm -f "$state"
}

gr() {
    local view
    state=$(mktemp)
    view="fzf-git-log $state run {1}"

    git remote -v | awk '{print $1 "\t" $2}' | uniq \
        | fzf-down --tac \
            --bind "ctrl-r:execute-silent(fzf-git-log $state toggle-graph)+refresh-preview" \
            --bind "ctrl-t:execute:fzf-view $view" \
            --preview "$view | head -500" \
        | command cut -d$'\t' -f1

    rm -f "$state"
}

gs() {
    local view
    view="git -c core.pager='less -+F -KMc' stash show -p --stat --color=always \$(cut -d: -f1 <<< {})"

    git stash list \
        | fzf-down --ansi --no-sort --reverse --multi --bind 'ctrl-s:toggle-sort' \
            --bind "ctrl-t:execute:fzf-view $view" \
            --preview "$view | head -500" \
        | command cut -d ':' -f1
}

gt() {
    local view
    view="git -c core.pager='less -+F -KMc' show --color=always {}"

    git tag --sort -version:refname \
        | fzf-down --multi --preview-window right:70% \
            --bind "ctrl-t:execute:fzf-view $view" \
            --preview "$view | head -500"
}

case "$1" in
    branch)
        gb "${@:2}"
        ;;
    file)
        gf "${@:2}"
        ;;
    hash)
        gh "${@:2}"
        ;;
    remote)
        gr "${@:2}"
        ;;
    stash)
        gs "${@:2}"
        ;;
    tag)
        gt "${@:2}"
        ;;
esac

