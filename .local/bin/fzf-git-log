#!/bin/bash

FILE="$1"
CMD="$2"
shift 2

if [[ ! -e "$FILE" ]]; then
    exit 1
fi

read -ra args <"$FILE"

case "$CMD" in
    run)
        git -c core.pager="less -+F -KMc" log --date=short --color=always \
            --format="%C(blue)%C(bold)%cd %C(cyan)%<(8,trunc)%aL %C(auto)%d %s %C(240)%h" \
            "${args[@]}" "$@"
        ;;
    switch)
        state=$(mktemp)
        fzf-view fzf-git-log "$state" _switch
        rm -f "$state"
        ;;
    _switch)
        res=$(fzf-git branch --height 100%)
        if [[ $res ]]; then
            args=("${args[@]/#[^-]*/}" "$res")
        fi
        echo "${args[@]}" > "${FILE}"
        ;;
    toggle-graph)
        if [[ " ${args[*]} " == *" --graph "* ]]; then
            read -ra args <<<"${args[@]/--graph/}"
        else
            args=(--graph "${args[@]}")
        fi
        echo "${args[@]}" > "${FILE}"
        ;;
    *)
        exit 1
        ;;
esac
