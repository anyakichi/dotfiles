#!/bin/bash

BACKLIGHT=/sys/class/backlight/intel_backlight

I3STATUS_RUNTIME_DIR=${XDG_RUNTIME_DIR}/i3status
I3STATUS_BACKLIGHT=${I3STATUS_RUNTIME_DIR}/backlight

BL_ACTUAL_BRIGHTNESS=${BACKLIGHT}/actual_brightness
BL_MAX_BRIGHTNESS=${BACKLIGHT}/max_brightness

update_backlight()
{
    local brightness

    brightness=$(<$BL_ACTUAL_BRIGHTNESS)
    echo $((brightness * 100 / MAX_BRIGHTNESS)) > "${I3STATUS_BACKLIGHT}"
    pkill -U "${USER}" -USR1 "^i3status$"
}

trap "exit" HUP INT TERM
trap "kill 0" EXIT

mkdir -p "${I3STATUS_RUNTIME_DIR}"

if [[ -d ${BACKLIGHT} ]]; then
    MAX_BRIGHTNESS=$(<$BL_MAX_BRIGHTNESS)

    update_backlight

    inotifywait -e MODIFY -m "${BL_ACTUAL_BRIGHTNESS}" 2>/dev/null | \
    while read -r; do
        # Wait some time to get backlight stable
        sleep 0.5
        update_backlight
    done &
fi

wait
